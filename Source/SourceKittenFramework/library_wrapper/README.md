# library_wrapper

Generate wrapper functions in Swift from API declaration in header file of Dynamic Link Library

## What is wrapper function
It does:
- Finds Dynamic Link Library from paths defined by code
- Loads founded Dynamic Link Library into process by `dlopen()`
- Lookup symbol from Dynamic Link Library on wrapper function called

These are processed lazily by Swift.

## How wrapper functions are created
It created from Generated Swift Interface of header file.

1. Open Header file on Xcode.  

    ```objective-c
    /**
     * \brief Invoke a request synchronously.
     *
     * The caller accepts ownership of the returned sourcekitd_response_t object and
     * should invoke \c sourcekitd_response_dispose on it when it is done with it.
     */
    SOURCEKITD_PUBLIC SOURCEKITD_NONNULL_ALL SOURCEKITD_WARN_RESULT
    sourcekitd_response_t
    sourcekitd_send_request_sync(sourcekitd_object_t req);
    ```

2. Save Generated Swift Interface of header to file (e.g. `sourcekitd_h.txt`).  

    ```swift
    /**
     * \brief Invoke a request synchronously.
     *
     * The caller accepts ownership of the returned sourcekitd_response_t object and
     * should invoke \c sourcekitd_response_dispose on it when it is done with it.
     */
    @warn_unused_result
    public func sourcekitd_send_request_sync(req: sourcekitd_object_t) -> sourcekitd_response_t
    ```

3. Convert Generated Swift Interface into library wrapper defined Swift file (e.g. `library_wrapper_sourcekitd.swift`) by using Python script.  

    ```swift
    // this file is generated by `convert_generated_interface_to_wrapper.py`
    #if SWIFT_PACKAGE
    import SourceKit
    #endif
    private let library = toolchainLoader.load("sourcekitd.framework/Versions/A/sourcekitd")

    // ...

    /**
    * \brief Invoke a request synchronously.
    *
    * The caller accepts ownership of the returned sourcekitd_response_t object and
    * should invoke \c sourcekitd_response_dispose on it when it is done with it.
    */
    @warn_unused_result
    public func sourcekitd_send_request_sync(req: sourcekitd_object_t) -> sourcekitd_response_t {
       return _sourcekitd_send_request_sync(req: req)
    }
    private let _sourcekitd_send_request_sync: @convention(c) (req: sourcekitd_object_t) -> sourcekitd_response_t = library.loadSymbol("sourcekitd_send_request_sync")
    ```

## What is contained in the library wrapper defined Swift file?
- Wrapper functions that created from `func` declared as `public` in Generated Swift Interface file.  
- Type declarations, variable declarations, extensions and typealiases that declared in Generate Swift Interface file are *omitted*. Those are intended to using imported declarations of original header.

## Why using Generated Swift Interface
Because only Swift knows how imported header will be declared in Swift.  
e.g.  
From:
```objective-c
/**
 * \brief Retrieve the CXIdxFile, file, line, column, and offset represented by
 * the given CXIdxLoc.
 *
 * If the location refers into a macro expansion, retrieves the
 * location of the macro expansion and if it refers into a macro argument
 * retrieves the location of the argument.
 */
CINDEX_LINKAGE void clang_indexLoc_getFileLocation(CXIdxLoc loc,
                                                   CXIdxClientFile *indexFile,
                                                   CXFile *file,
                                                   unsigned *line,
                                                   unsigned *column,
                                                   unsigned *offset);
```
To:
```swift
/**
* \brief Retrieve the CXIdxFile, file, line, column, and offset represented by
* the given CXIdxLoc.
*
* If the location refers into a macro expansion, retrieves the
* location of the macro expansion and if it refers into a macro argument
* retrieves the location of the argument.
*/
public func clang_indexLoc_getFileLocation(loc: CXIdxLoc,
                                           _ indexFile: UnsafeMutablePointer<CXIdxClientFile>,
                                           _ file: UnsafeMutablePointer<CXFile>,
                                           _ line: UnsafeMutablePointer<UInt32>,
                                           _ column: UnsafeMutablePointer<UInt32>,
                                           _ offset: UnsafeMutablePointer<UInt32>)
// indent is edited on quotation
```
Converting directly from header to Swift is hard because:
- How expanding Macros? `CINDEX_LINKAGE`
- What type is proper in Swift? `unsigned`
- Which is function?
- etc.

## Why original comment is included the library wrapper defined Swift file
For documentation comment.

## Why wrapper functions are `public`
If clients directly calling `sourcekitd` or `clang` exists, they can achieve them using these wrapper.
I don't know whether such client exists or not.
